<html>
<head>
    <title>DataTables KeepConditions Plugin - ColReorder</title>

    <!-- jQuery Library -->
    <script src="http://code.jquery.com/jquery-2.1.4.js"></script>

    <!-- Core DataTables library/CSS -->
    <script src="http://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css">

    <!-- DataTables Search Highlight plugin (Not required, just makes it easier to realize the tables filtered -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/default.min.css">

    <!-- DataTables Buttons Extension library/CSS (Only required if using the 'Copy Conditions' button -->
    <script src="https://cdn.datatables.net/buttons/1.0.3/js/dataTables.buttons.min.js"></script>
    <link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/buttons/1.0.3/css/buttons.dataTables.min.css">

    <!-- DataTables ColReorder Extension library/CSS (Only required if using the ColReorder extension) -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/colreorder/1.3.0/css/colReorder.dataTables.min.css">
    <script src="https://cdn.datatables.net/colreorder/1.3.0/js/dataTables.colReorder.min.js"></script>

    <!-- Keep Conditions Plugin Library -->
    <script src="../dist/dataTables.keepConditions.js"></script>

    <!-- Just some JS/CSS for the examples (Also, not required) -->
    <script src="examples.js"></script>
    <link rel="stylesheet" href="examples.css">
</head>
<body>
<h1>DataTables KeepConditions Plugin - <i>Child Rows</i></h1>
<div class="content-box">
    <strong>Description:</strong> Example of <em>keepConditions</em> working with the <a href="https://datatables.net/examples/api/row_details.html" target="_blank">ColReorder</a> extension from DataTables.
</div>
<a href="index.html">Other Examples</a>
<hr/><h2>Example Source Code</h2>
<div id="example-source" class="content-box">
    Here's the exact jQuery code for this plugin example</div>
<pre id="example-js-preview">
<code class="javascript">
</code>
</pre>
<hr/>
<h2>Example DataTable</h2>
<div class="content-box">
    The table below was initiated with <em>KeepConditions</em> and the <a href="http://datatables.net/extensions/colreorder/" target="_blank">ColReorder</a> extension:
</div>
<table id="example" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th></th>
                <th>Name</th>
                <th>Position</th>
                <th>Office</th>
                <th>Salary</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th></th>
                <th>Name</th>
                <th>Position</th>
                <th>Office</th>
                <th>Salary</th>
            </tr>
        </tfoot>
    </table>


















<!DOCTYPE html>
<html>
  <head>
    <script src="https://code.jquery.com/jquery-1.12.3.js"></script>
    <style type="text/css">
body {
  font: 90%/1.45em "Helvetica Neue", HelveticaNeue, Verdana, Arial, Helvetica, sans-serif;
  margin: 0;
  padding: 0;
  color: #333;
  background-color: #fff;
}
td.details-control {
    background: url('https://datatables.net/examples/resources/details_open.png') no-repeat center center;
    cursor: pointer;
}
tr.shown td.details-control {
    background: url('https://datatables.net/examples/resources/details_close.png') no-repeat center center;
}
    </style>
    <link href="https://nightly.datatables.net/css/jquery.dataTables.css" rel="stylesheet" type="text/css" />
    <script src="https://nightly.datatables.net/js/jquery.dataTables.js"></script>

    <meta charset=utf-8 />
    <title>DataTables - JS Bin</title>
  </head>
  <body>
    <div class="container">
      <table id="example" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th></th>
                <th>Name</th>
                <th>Position</th>
                <th>Office</th>
                <th>Salary</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th></th>
                <th>Name</th>
                <th>Position</th>
                <th>Office</th>
                <th>Salary</th>
            </tr>
        </tfoot>
    </table>
    </div>
  </body>
</html>
<script>
$(document).ready(function() {
    var table = $('#example').DataTable( {
        ajax: 'data/ajax-src-objects.json',
        columns: [{
          name           : 'control',
          className      : 'details-control',
          orderable      : false,
          data           : null,
          defaultContent : ''
        },{ 
          name: 'name',
          data: 'name'
        },{
          name: 'position',
          data: 'position'
        },{ 
          name: 'office',
          data: 'office'
        },{ 
          name: 'salary',
          data: 'salary'
        }],
        order: [[1, 'asc']],
        initComplete: function( settings, json ) {
            console.debug('[initComplete A] Settings:',settings, 'json:',json)

            /*var _cbFunc = function( row, data, displayIndex, displayIndexFull ) {
                // Bold the grade for all 'A' grade browsers
                if ( data[4] == "A" ) {
                    $('td:eq(4)', row).html( '<b>A</b>' );
                }
            }
             
            function _fnCallbackReg( oSettings, sStore, fn, sName ){
                if( sStore && oSettings[sStore] === undefined )
                    oSettings[sStore] = []

                if ( sStore && fn )
                    oSettings[sStore].push( {
                        "fn": fn,
                        "sName": sName
                    } )
            }
            */


            // function _fnCallbackReg( oSettings, sStore, fn, sName )
            _fnCallbackReg( settings, 'aoChildOpened', function( ) {
                console.debug( '[Executing Callback aaoChildOpened] arguments:', arguments )
            }, 'user' )

            console.debug('[initComplete B] Settings:',settings, 'json:',json)
        }
    } );
     
    // Add event listener for opening and closing details
    $('#example tbody').on('click', 'td.details-control', function () {
        var tr = $(this).closest('tr');
        var row = table.row( tr );
 
        //_fnCallbackFire( table, ['aoChildOpened', 'childOpen'], [ 'hello','world', 1])
        window._fnCallbackFire( table, 'aoChildOpened', [ 'hello','world', 1])



       // console.log('DT Child toggle btn :', )


        //console.log('table',table)

        if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            //
            // Open this row
            row.child( format(row.data()) ).show();
            tr.addClass('shown');
        }
    } );
} );

    /**
     * Register a callback function. Easily allows a callback function to be added to
     * an array store of callback functions that can then all be called together.
     *  @param {object} oSettings dataTables settings object
     *  @param {string} sStore Name of the array storage for the callbacks in oSettings
     *  @param {function} fn Function to be called back
     *  @param {string} sName Identifying name for the callback (i.e. a label)
     *  @memberof DataTable#oApi
     *
            _fnCallbackReg( oSettings, 'aoDrawCallback',       oInit.fnDrawCallback,      'user' );
            _fnCallbackReg( oSettings, 'aoServerParams',       oInit.fnServerParams,      'user' );
            _fnCallbackReg( oSettings, 'aoStateSaveParams',    oInit.fnStateSaveParams,   'user' );
            _fnCallbackReg( oSettings, 'aoStateLoadParams',    oInit.fnStateLoadParams,   'user' );
            _fnCallbackReg( oSettings, 'aoStateLoaded',        oInit.fnStateLoaded,       'user' );
            _fnCallbackReg( oSettings, 'aoRowCallback',        oInit.fnRowCallback,       'user' );
            _fnCallbackReg( oSettings, 'aoRowCreatedCallback', oInit.fnCreatedRow,        'user' );
            _fnCallbackReg( oSettings, 'aoHeaderCallback',     oInit.fnHeaderCallback,    'user' );
            _fnCallbackReg( oSettings, 'aoFooterCallback',     oInit.fnFooterCallback,    'user' );
            _fnCallbackReg( oSettings, 'aoInitComplete',       oInit.fnInitComplete,      'user' );
            _fnCallbackReg( oSettings, 'aoPreDrawCallback',    oInit.fnPreDrawCallback,   'user' );
            function _fnCallbackReg( oSettings, sStore, fn, sName )
     */
    var _cbFunc = function( row, data, displayIndex, displayIndexFull ) {
        // Bold the grade for all 'A' grade browsers
        // if ( data[4] == "A" )  $('td:eq(4)', row).html( '<b>A</b>' )
        console.log( '_cbFunc - data:', data)
        return data
    }


    var api = new $.fn.dataTable.Api( $( '#example' ) )

    //window._fnCallbackReg( api.settings(), 'aoChildOpened', _cbFunc , 'user' )
    function _fnCallbackReg( oSettings, sStore, fn, sName ){
        var api = new $.fn.dataTable.Api( 
            //$( '#example' ) 
            oSettings
        )

        console.log('[_fnCallbackReg] API:', api)
        //return
        
        console.debug('Registering Callback - Func: %s; Store: %s', sName, sStore )

        if ( fn ){
            if( $.isArray(oSettings[sStore] ) || $.inArray( sStore, oSettings ) === -1 )
                oSettings[sStore] = []

            oSettings[sStore].push( {
                "fn": fn,
                "sName": sName
            } );
        }
    }

    window._fnCallbackReg = _fnCallbackReg

    /**
     * Fire callback functions and trigger events. Note that the loop over the
     * callback array store is done backwards! Further note that you do not want to
     * fire off triggers in time sensitive applications (for example cell creation)
     * as its slow.
     *  @param {object} settings dataTables settings object
     *  @param {string} callbackArr Name of the array storage for the callbacks in
     *      oSettings
     *  @param {string} eventName Name of the jQuery custom event to trigger. If
     *      null no trigger is fired
     *  @param {array} args Array of arguments to pass to the callback function /
     *      trigger
     *  @memberof DataTable#oApi
            _fnCallbackFire( oSettings, null, 'order', [oSettings, aSort, sortedColumns] );
            _fnCallbackFire( settings, null, 'column-sizing', [settings] );
            _fnCallbackFire( oSettings, 'aoRowCreatedCallback', null, [nTr, rowData, iRow] );
            _fnCallbackFire( oSettings, 'aoRowCallback', null,
            _fnCallbackFire( oSettings, 'aoHeaderCallback', 'header', [ $(oSettings.nTHead).children('tr')[0],
            _fnCallbackFire( oSettings, 'aoFooterCallback', 'footer', [ $(oSettings.nTFoot).children('tr')[0],
            _fnCallbackFire( oSettings, 'aoDrawCallback', 'draw', [oSettings] );
            _fnCallbackFire( oSettings, 'aoServerParams', 'serverParams', [data] );
            _fnCallbackFire( oSettings, null, 'xhr', [oSettings, json, oSettings.jqXHR] );
            _fnCallbackFire( oSettings, null, 'preXhr', [oSettings, data] );
            _fnCallbackFire( oSettings, null, 'search', [oSettings] );
            _fnCallbackFire( settings, null, 'preInit', [settings] );
            _fnCallbackFire( settings, null, 'plugin-init', [settings, json] );
            _fnCallbackFire( settings, 'aoInitComplete', 'init', [settings, json] );
            _fnCallbackFire( settings, null, 'length', [settings, len] );
            _fnCallbackFire( settings, null, 'page', [settings] );
            _fnCallbackFire( settings, null, 'processing', [settings, show] );
            _fnCallbackFire( settings, "aoStateSaveParams", 'stateSaveParams', [settings, state] );
            _fnCallbackFire( settings, 'aoStateLoaded', 'stateLoaded', [settings, state] );
            _fnCallbackFire( settings, null, 'error', [ settings, tn, msg ] );
            _fnCallbackFire( settings, null, 'column-visibility', [settings, column, vis, calc] );
            _fnCallbackFire( settings, "aoDestroyCallback", "destroy", [settings] );

            _fnCallbackFire( settings, 'aoChildOpened', 'childOpen', [ 'hello','world', 1])
     */
    // function _fnCallbackReg( oSettings, sStore, fn, sName )
    function _fnCallbackFire( settings, callbackArr, eventName, args ){
        var ret = [];
        console.debug('[_fnCallbackFire] eventName:', eventName )
        console.debug('[_fnCallbackFire] args:', args )
        console.debug('[_fnCallbackFire] callbackArr:',callbackArr )

        if ( callbackArr ) {
            console.debug( '[_fnCallbackFire] callbackArr Found' )

            if( $.inArray( callbackArr, Object.keys( settings ) ) === -1)
                settings[ callbackArr ] = []

            console.debug( 'settings', settings )
            console.debug( 'settings[ callbackArr ]', settings[ callbackArr ])

            ret = $.map( settings[ callbackArr ].slice().reverse(), function (val, i) {
                var cbResult = val.fn.apply( settings.oInstance, args )
                console.debug('[_fnCallbackFire] (int: %s; val: %s) cbResult', i, val, cbResult)
                return cbResult
            } );
        }
        else {
            console.debug( '[_fnCallbackFire] No callbackArr' )
        }
    
        if ( eventName !== null ) {
            var e = $.Event( eventName+'.dt' );
    
            $(settings.nTable).trigger( e, args );
    
            ret.push( e.result );
        }
    
        return ret;
    }

    window._fnCallbackFire2 = _fnCallbackFire

    function _fnExternApiFunc ( fn ) {  
         console.debug( 'Function _fnExternApiFunc] called...')  
        return function() {
            var args = [_fnSettingsFromNode( this[DataTable.ext.iApiIndex] )].concat(
                Array.prototype.slice.call( arguments )
            ),
            jsonArgs = JSON.stringify( args ),
            jsonArguments = JSON.stringify( arguments )

            console.debug( '[_fnExternApiFunc] arguments: %s; args: %s', jsonArguments, jsonArgs )

            return DataTable.ext.internal[fn].apply( this, args );
        };

    }
    /**
     * Return the settings object for a particular table
     *  @param {node} table table we are using as a dataTable
     *  @returns {object} Settings object - or null if not found
     *  @memberof DataTable#oApi
     */
    function _fnSettingsFromNode ( table ){
        var settings = DataTable.settings,
            indexes = $.inArray( table, _pluck( settings, 'nTable' ) )
    
        return idx !== -1 ?
            settings[ idx ] :
            null;
    }
    

/* Formatting function for row details - modify as you need */
function format ( d ) {
    return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
        '<tr>'+
            '<td>Full name:</td>'+
            '<td>'+d.name+'</td>'+
        '</tr>'+
        '<tr>'+
            '<td>Extension number:</td>'+
            '<td>'+d.extn+'</td>'+
        '</tr>'+
        '<tr>'+
            '<td>Extra info:</td>'+
            '<td>And any further details here (images etc)...</td>'+
        '</tr>'+
    '</table>';
}
</script>